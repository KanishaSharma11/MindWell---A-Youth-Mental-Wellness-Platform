<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance for Mental Wellness - Enhanced</title>

    <style>
        :root {
            /* Palette 1 - Earth Tones */
            --sage-green: #6B8A7A;
            --warm-gold: #DAC896;
            --soft-pink: #E8D5D5;
            --peach: #E8B894;
            --dusty-blue: #A8BFC4;
            --cream: #E8E0D5;
            
            /* Palette 2 - Ocean & Sky */
            --deep-blue: #5B7AA0;
            --light-blue: #C5D4E6;
            --warm-beige: #E8DDD4;
            --mint-green: #C5D4C4;
            --teal: #7AA09A;
            
            /* Neutral */
            --white: #ffffff;
            --text-dark: #2c2c2c;
            --text-light: #666;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--warm-beige) 50%, var(--light-blue) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Floating background elements */
        .bg-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }

        .circle-1 {
            width: 120px;
            height: 120px;
            background: var(--sage-green);
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .circle-2 {
            width: 80px;
            height: 80px;
            background: var(--peach);
            top: 60%;
            right: 15%;
            animation-delay: 2s;
        }

        .circle-3 {
            width: 150px;
            height: 150px;
            background: var(--dusty-blue);
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 0 0 30px 30px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--sage-green), var(--deep-blue));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            animation: glow 3s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .header p {
            color: var(--text-light);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Main container */
        .game-container {
            display: flex;
            gap: 2rem;
            width: 90%;
            max-width: 1400px;
            margin: 0 auto 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 2rem;
            box-shadow: 0 20px 60px var(--shadow);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .game-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
        }

        .video-container {
            flex: 1;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(45deg, var(--sage-green), var(--teal));
            padding: 3px;
            transition: all 0.3s ease;
        }

        .video-container:hover {
            transform: scale(1.02);
        }

        .video-inner {
            background: var(--text-dark);
            border-radius: 17px;
            height: 400px;
            position: relative;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 17px;
        }

        .user-camera-container video {
            transform: scaleX(-1);
        }

        #pose-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .video-label {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            z-index: 15;
        }

        /* Controls section */
        .controls {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px var(--shadow);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 50px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button:hover:before {
            left: 100%;
        }

        #start-button {
            background: linear-gradient(45deg, var(--sage-green), var(--teal));
            box-shadow: 0 8px 25px rgba(107, 138, 122, 0.4);
        }

        #start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(107, 138, 122, 0.6);
        }

        #stop-button {
            background: linear-gradient(45deg, var(--peach), #e07a5f);
            box-shadow: 0 8px 25px rgba(232, 184, 148, 0.4);
        }

        #stop-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(232, 184, 148, 0.6);
        }

        /* Score display */
        .score-container {
            background: linear-gradient(45deg, var(--warm-gold), var(--peach));
            padding: 1.5rem;
            border-radius: 20px;
            margin: 1.5rem 0;
            box-shadow: 0 8px 25px rgba(218, 200, 150, 0.3);
            position: relative;
            overflow: hidden;
        }

        .score-container:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%); }
            100% { transform: translateX(100%) translateY(100%); }
        }

        #score-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-dark);
            position: relative;
            z-index: 2;
        }

        /* Countdown */
        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            font-weight: bold;
            color: var(--white);
            text-shadow: 
                0 0 10px rgba(255,255,255,0.8),
                0 0 20px rgba(255,255,255,0.6),
                0 0 30px rgba(255,255,255,0.4);
            z-index: 20;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* Status indicators */
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        .status-item {
            text-align: center;
            padding: 0.5rem;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .camera-status { background: var(--mint-green); }
        .pose-status { background: var(--dusty-blue); }
        .music-status { background: var(--soft-pink); }

        .status-text {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .video-inner {
                height: 300px;
            }

            #countdown {
                font-size: 5rem;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Interactive particles */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--warm-gold);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-float 3s ease-out forwards;
        }

        @keyframes particle-float {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0);
            }
        }

        /* Welcome message */
        .welcome-message {
            background: linear-gradient(45deg, var(--soft-pink), var(--light-blue));
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            text-align: center;
            color: var(--text-dark);
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="bg-elements">
        <div class="floating-circle circle-1"></div>
        <div class="floating-circle circle-2"></div>
        <div class="floating-circle circle-3"></div>
    </div>

    <header class="header">
        <h1>üíÉ Dance for Mental Wellness üï∫</h1>
        <p>Move your body, elevate your mind. Experience the joy of dance while nurturing your mental wellbeing through interactive movement therapy.</p>
    </header>

    <div class="welcome-message">
        <h3>üåü Welcome to Your Wellness Journey</h3>
        <p>Get ready to dance, move, and feel amazing! Our AI-powered system will track your movements and encourage you every step of the way.</p>
    </div>

    <main class="game-container">
        <div class="video-container user-camera-container">
            <div class="video-label">üì∑ Your Dance Space</div>
            <div class="video-inner">
                <video id="user-video" autoplay playsinline muted></video>
                <canvas id="pose-canvas"></canvas>
                <div id="countdown" class="hidden">3</div>
            </div>
        </div>

        <div class="video-container reference-video-container">
            <div class="video-label">üé≠ Reference Dance</div>
            <div class="video-inner">
                <video id="reference-video" playsinline loop></video>
            </div>
        </div>
    </main>

    <div class="controls">
        <div class="status-bar">
            <div class="status-item">
                <div class="status-icon camera-status">üì∑</div>
                <div class="status-text">Camera Ready</div>
            </div>
            <div class="status-item">
                <div class="status-icon pose-status">ü§∏</div>
                <div class="status-text">Pose Detection</div>
            </div>
            <div class="status-item">
                <div class="status-icon music-status">üéµ</div>
                <div class="status-text">Music Sync</div>
            </div>
        </div>

        <div class="score-container">
            <p id="score-display">üèÜ Score: 0 points</p>
        </div>

        <div class="button-group">
            <button id="start-button">
                üöÄ Start Dancing
            </button>
            <button id="stop-button" class="hidden">
                ‚èπÔ∏è Stop Session
            </button>
        </div>

        <div class="welcome-message" style="margin-top: 2rem;">
            <p><strong>Instructions:</strong> Position yourself in front of the camera, click "Start Dancing", and follow the reference movements. The system will track your poses and provide real-time feedback!</p>
        </div>
    </div>

    <script type="module">
import {
    FilesetResolver,
    PoseLandmarker,
    DrawingUtils
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

let isGameActive = false;
let score = 0;

const startButton = document.getElementById("start-button");
const stopButton = document.getElementById("stop-button");
const countdownElement = document.getElementById("countdown");
const referenceVideo = document.getElementById("reference-video");
const scoreDisplay = document.getElementById("score-display");
const userVideo = document.getElementById("user-video");
const canvas = document.getElementById("pose-canvas");
const ctx = canvas.getContext("2d");

let poseLandmarker;
let drawingUtils;
let lastUserTime = -1;
let lastRefTime = -1;
let lastVideoTime = -1;
let poseDetectionFrame = null;

// ----------------- small helper: add slide animations for notifications -----------------
const animationStyle = document.createElement("style");
animationStyle.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(animationStyle);

// ================== Notification helper ==================
function showNotification(message, type = "info") {
    const notification = document.createElement("div");
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.28s ease-out;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        max-width: 320px;
    `;

    // color by type
    if (type === "error") {
        notification.style.background = "linear-gradient(45deg, #e07a5f, #f4a261)";
    } else if (type === "success") {
        notification.style.background = "linear-gradient(45deg, #6CCB8E, #4AAE7F)";
    } else {
        notification.style.background = "linear-gradient(45deg, #6B8A7A, #7AA09A)";
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = "slideOut 0.28s ease-in forwards";
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ================== Status helper ==================
function updateStatus(statusClass, icon, text) {
    const statusIcon = document.querySelector(`.${statusClass}`);
    if (!statusIcon) return;
    const statusText = statusIcon.nextElementSibling;
    if (statusIcon) statusIcon.innerHTML = icon;
    if (statusText) statusText.textContent = text;
}

// ================== MediaPipe Setup ==================
async function initPoseLandmarker() {
    const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
    );

    poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
        baseOptions: {
            modelAssetPath:
                "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"
        },
        runningMode: "VIDEO",
        numPoses: 1
    });

    drawingUtils = new DrawingUtils(ctx);
    console.log("Pose Landmarker initialized");
}

// ================== Webcam Setup ==================
const setupWebcam = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30 }
            },
            audio: false
        });
        userVideo.srcObject = stream;

        userVideo.onloadeddata = () => {
            userVideo.play().catch(e => console.warn("userVideo play prevented:", e));
            updateStatus("camera-status", "‚úÖ", "Camera Active");
            resizeCanvasToVideo();
        };
    } catch (err) {
        console.error("Error accessing webcam:", err);
        updateStatus("camera-status", "‚ùå", "Camera Error");
        showNotification("Unable to access webcam. Please check permissions.", "error");
    }
};

// Resize canvas to match the user's video display size (handles DPR)
function resizeCanvasToVideo() {
    // use the container size (canvas is absolute over the video)
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.max(1, Math.round(rect.width * dpr));
    canvas.height = Math.max(1, Math.round(rect.height * dpr));
    ctx.scale(dpr, dpr);
}

// keep canvas in sync on resize / orientation
window.addEventListener("resize", () => {
    // reset transform then resize
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    resizeCanvasToVideo();
});

// ================== Pose Comparison ==================
function compareUserToReference(userLandmarks, refLandmarks) {
    if (!userLandmarks || !refLandmarks) return 0;
    // Use normalized coordinates given by MediaPipe (x,y,z)
    let totalDiff = 0;
    let count = Math.min(userLandmarks.length, refLandmarks.length);

    for (let i = 0; i < count; i++) {
        const dx = (userLandmarks[i].x || 0) - (refLandmarks[i].x || 0);
        const dy = (userLandmarks[i].y || 0) - (refLandmarks[i].y || 0);
        const dz = (userLandmarks[i].z || 0) - (refLandmarks[i].z || 0);
        totalDiff += Math.sqrt(dx * dx + dy * dy + dz * dz);
    }

    const avgDiff = totalDiff / count; // smaller is better
    // Convert to a similarity score 0..100 and then reduce to a small per-frame point value
    const similarity = Math.max(0, 100 - avgDiff * 500);
    // Return small integer points per frame so score grows reasonably
    return Math.floor(similarity / 20); // 0..5 approx per frame
}

// ================== Pose Detection loop ==================
async function detectPose() {
    if (!poseLandmarker) return;

    try {
        // Avoid repeated detection for same frame times to reduce work
        const userTime = userVideo.currentTime;
        const refTime = referenceVideo.currentTime;

        if (userTime !== lastVideoTime) {
            lastVideoTime = userTime;
            
            const userResults = poseLandmarker.detectForVideo(userVideo, performance.now());
            const refResults = poseLandmarker.detectForVideo(referenceVideo, performance.now());

            // clear canvas and draw user landmarks (overlay)
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (userResults && userResults.landmarks && userResults.landmarks.length) {
                const landmarks = userResults.landmarks[0];
                // draw detected landmarks scaled to canvas
                drawingUtils.drawLandmarks(landmarks, { radius: 4 });
                drawingUtils.drawConnectors(landmarks, PoseLandmarker.POSE_CONNECTIONS);
            }

            // If both exist, compare and update score
            if (
                userResults && userResults.landmarks && userResults.landmarks.length &&
                refResults && refResults.landmarks && refResults.landmarks.length
            ) {
                const pts = compareUserToReference(userResults.landmarks[0], refResults.landmarks[0]);
                if (pts > 0) {
                    score += pts;
                    updateScore();
                }
            }
        }
    } catch (err) {
        // log but keep going
        console.warn("detectPose error:", err);
    }

    if (isGameActive) {
        poseDetectionFrame = requestAnimationFrame(detectPose);
    }
}

// ================== Game Logic ==================
const startGame = async () => {
    // ensure canvas sized
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    resizeCanvasToVideo();

    isGameActive = true;
    startButton.classList.add("hidden");
    stopButton.classList.remove("hidden");
    countdownElement.classList.remove("hidden");

    let count = 3;
    const countdownInterval = setInterval(() => {
        countdownElement.innerText = count;
        countdownElement.style.color = `hsl(${count * 90 % 360}, 70%, 60%)`;
        count--;

        if (count < 0) {
            clearInterval(countdownInterval);
            countdownElement.classList.add("hidden");

            // Start reference video (this will play its own audio)
            referenceVideo.play().then(() => {
                updateStatus("music-status", "üéµ", "Music Playing");
            }).catch(err => {
                console.warn("referenceVideo play prevented:", err);
                showNotification("Reference video playback blocked (autoplay). Click play manually.", "error");
            });

            updateStatus("pose-status", "ü§∏", "Tracking Active");
            showNotification("Let's dance! Follow the movements!", "success");

            // start detection loop
            detectPose();
        }
    }, 1000);
};

const stopGame = () => {
    if (poseDetectionFrame) {
        cancelAnimationFrame(poseDetectionFrame);
    }
    isGameActive = false;
    referenceVideo.pause();

    const finalScore = score;
    let message = "";

    if (finalScore > 300) {
        message = `üéâ Amazing! You scored ${finalScore} points! You're a dancing star!`;
    } else if (finalScore > 100) {
        message = `üåü Great job! You scored ${finalScore} points! Keep dancing!`;
    } else {
        message = `üí™ You scored ${finalScore} points! Every step counts - keep moving!`;
    }
    showNotification(message, "success");

    // Reset
    score = 0;
    updateScore();
    stopButton.classList.add("hidden");
    startButton.classList.remove("hidden");
    updateStatus("pose-status", "‚è∏", "Tracking Paused");
    updateStatus("music-status", "üîá", "Music Paused");
};

// ================== Small helpers ==================
function updateScore() {
    scoreDisplay.textContent = `üèÜ Score: ${score} points`;
}

// ================== Init ==================
const init = async () => {
    await setupWebcam();
    await initPoseLandmarker();

    // Set your reference video here (local file or public mp4)
    // If using a local file put it in same folder and use "dance.mp4"
    // Example:
    referenceVideo.src = "Screen Recording 2025-09-17 194050.mp4"; // <-- replace with your mp4 path or public mp4 url

    // Make sure referenceVideo triggers canvas resizing when it loads
    referenceVideo.onloadeddata = () => {
        resizeCanvasToVideo();
        // ensure audio plays when user clicks Start (autoplay restrictions)
        updateStatus("music-status", "üéµ", "Ready");
    };

    // Attach UI listeners
    startButton.addEventListener("click", startGame);
    stopButton.addEventListener("click", stopGame);

    showNotification("Welcome! Set up your camera and start dancing!", "info");
};

init();
</script>
</body>
</html>
